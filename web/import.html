<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Gilbert M." />


<title>Importing the data</title>

<script src="site_libs/jquery-1.12.4/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="site_libs/datatables-binding-0.15/datatables.js"></script>
<link href="site_libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="site_libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="site_libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="site_libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="site_libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="css\sstyle.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">TCP Project</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="general.html">General</a>
</li>
<li>
  <a href="report1921.html">1921</a>
</li>
<li>
  <a href="report1911.html">1911</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<div class="pageContainer">
  <div class="pNav">
    <ul>
      <li>
        <a id="nav-import" href="import.html">Issues on Intial Importation</a>
      </li>
      <li>
        <a id="nav-enuname" href="enuName.html">Cleaning up Enumerator Name</a>
      </li>
      <li>
         <a id="nav-merge" href="mergeDemo.html">Fixing and Merging Demovars</a>
      </li>
      <li>
         <a id="nav-verify" href="verifyDemo.html">Verify and Crosstab Demovar</a>
      </li>
    </ul>
   
  </div>
  <div class="pContent">

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Importing the data</h1>
<h4 class="author">Gilbert M.</h4>
<h4 class="date">Created on: 20 April, 2020, Updated on: 15 August, 2020</h4>

</div>


<hr />
<p>This describes the importation process from the .txt file into R, the issues faced during and the solution applied</p>
<div id="issue-with-direct-importation" class="section level3">
<h3>Issue with direct importation</h3>
<p>The original file is 49176_8991_1921_Candadian_Census_RawDelivery.txt Direct importation failled as some lines have number of columns different that the one auto detected. On investigation, it happen that the “|” symbole which is used as column delimitor in the .txt is included in some some field. The investigation involve reading each line of the .txt file without column sparation with readLines.</p>
<pre class="r"><code># Read all line for investigation
allLine &lt;- readLines(f1921,encoding = &quot;UTF-8&quot;)
library(stringr)
# Count number of delimiter per line
# Make parallel Call for 6 cores cpu
cl &lt;- makeCluster(getOption(&quot;cl.cores&quot;, 6))
colsCount &lt;- parLapply(cl,allLine,str_count,fixed(&quot;|&quot;))
stopCluster(cl)
# Combine results from all cpu core
colsCount &lt;- do.call(rbind,colsCount)
colsCount &lt;- data.table(&quot;coln&quot;=colsCount)
#</code></pre>
<div id="frequence-for-colscount" class="section level4">
<h4>Frequence for colsCount</h4>
<pre class="r"><code>&gt; colsCount[,.N, by= coln.V1]
   coln.V1       N
1:      61 8755356
2:      62      29
&gt; </code></pre>
<p>There a total of 29 out N of lines spread over the entire file where the number of columns is 63 (62 “|” present ) rather than 62 (61 “|” presents). So each time such a lumn is meant, the importation is broken at best or continue with default handling which vary from software to software. In R most package and function would report the error rather than implement a default handling.</p>
<p>The 29 lines with issue are saved in dta63.xlsx for later investigation. The remanining lines are saved unprocessed into dta62.rds</p>
</div>
</div>
<div id="optimizing-the-data-for-storage" class="section level3">
<h3>Optimizing the data for storage</h3>
<p>Working with the data has been a used challenge because of this size and structure. For instance loading full data saved in dta62.rds take up lage amount of memory and is quite slow for live query. Futhermore its almost impossible to convert to other format such .sav and .sas as the number character is some variable surpasses the limits. These variable variable will probably be trimmed to a character limit if importation is forced for example. The following table show the relative size of each variables in term of total space or memory.</p>
<div id="htmlwidget-7bd5f0e7553b7b7bddb1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7bd5f0e7553b7b7bddb1">{"x":{"filter":"none","data":[["ImageFileName","ImageFolder","unique_identifier","SourceArchiveRoll","ResidenceProvince","ResidenceCounty","ResidenceEnumerationDistrict","ResidenceSubEnumerationDistrictName","ResidenceSubEnumerationDistrict","ResidenceCity","SourcePageNumber","EnumeratorGivenName","EnumeratorSurname","ResidenceCountry","ResidenceDay","ResidenceMonth","ResidenceYear","SourceDescription","SequenceNumber","LineNumber","HouseNumber","Famnum","NamePrefix","GivenName","Surname","NameSuffix","ResidenceParish","ResidenceLandSection","ResidenceTownship","ResidenceRange","ResidenceMeridian","ResidenceMunicipality","ResidenceHomeOwnership","ResidenceMonthlyRental","ResidenceClassOfHouse","ResidenceConstructMaterials","ResidenceNumberRooms","RelationToHead","Gender","MaritalStatus","ResidenceAge","BirthPlace","FatherBirthPlace","MotherBirthPlace","ArrivalYear","NaturalizationYear","Nationality","Race","ResidenceAbleToSpeakEnglish","ResidenceSpeaksFrench","ResidenceLanguageSpoken","ResidenceReligion","ResidenceCanRead","ResidenceCanWrite","ResidenceMonthsAtSchool","Occupation","ResidenceClassofWorker","ResidenceIndustry","ResidenceIncome","ResidenceOutOfWork","ResidenceWeeksOutOfWork","ResidenceIllnessWeeksOutOfWork"],[196234,162,8744005,10,12,229,225,3674,241,22492,113,6587,6676,2,2,2,2,6815,65,52,1429,1524,52,678017,407684,24,570546,121005,616,382,861,30033,1679,10212,2542,7509,4391,13074,6,11,127,15280,12843,12094,125,2941,4856,5088,94,96,94727,28927,131,127,61694,185669,4282,334441,7298,47743,3625,2569],[166352296,70043072,null,8744004,73449808,111610463,21819128,149220623,16367639,128750365,12938748,51066948,57567219,52464024,8744004,26232012,34976016,716631253,34987396,15844255,20565781,20927243,59020,56809807,57687258,78124,75758000,12192475,2102574,1897380,1794630,73953567,2249556,5447906,2781151,4744072,5843593,44294613,43436779,62395667,15949163,66812542,63266353,65077047,7872477,2794775,52183718,58545471,12831415,12880023,24296712,59614055,12900274,12897454,14074572,35941678,10909657,31666971,6909417,4681111,5527301,2796188],[6,2,null,0,3,4,1,5,1,5,0,2,2,2,0,1,1,25,1,1,1,1,0,2,2,0,3,0,0,0,0,3,0,0,0,0,0,2,2,2,1,2,2,2,0,0,2,2,0,0,1,2,0,0,0,1,0,1,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Variable<\/th>\n      <th>Unique<\/th>\n      <th>Size<\/th>\n      <th>Perc<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[[3,"desc"]],"columnDefs":[{"className":"dt-left","targets":0},{"className":"dt-right","targets":[1,2,3]}],"scrollX":true,"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>For memory saving purpose an optimized version of the full data is saved in 1921_Optimized.rds. The optimization consist of converting character column into factor. Using this file instead of the original will take about 30% less memory.</p>
</div>
<div id="reduce-data-faster-query-and-export" class="section level3">
<h3>Reduce data faster query and export</h3>
<p>Even with reduced file size, the full data still can’t be exported to .sav or .sas as there still limitation such as the number of factors. For example trying to export to .sav will produce error.</p>
<pre class="r"><code>&gt; write_sav(dta1921, file.path(offpath,&quot;1921_Optimized.sav&quot;))
Error: SPSS only supports levels with &lt;= 120 characters
Problems: `ResidenceCity`, `SourceDescription`</code></pre>
<p>Furthermore, .sav file format take a lot of disk space and is even difficult to load into SPSS. To produced a workable version of the data, we’ve removed the following variables and export the result into 1921_Reduced.rds and 1921_Reduced.zsav. Saving as .zsav further reduced the file size by about 10% of the .sav format. This workable version is intended to be used by team member working on recoding variables</p>
<pre class="r"><code>xvars &lt;- c(&quot;ImageFolder&quot;,&quot;SourceDescription&quot;,&quot;ResidenceYear&quot;,&quot;ResidenceDay&quot;,
           &quot;ResidenceMonth&quot;,&quot;ResidenceEnumerationDistrict&quot;,
           &quot;ResidenceCity&quot;,&quot;SourceArchiveRoll&quot;,&quot;ResidenceTownship&quot;,
           &quot;ResidenceSubEnumerationDistrict&quot;,&quot;ResidenceRange&quot;,&quot;ResidenceParish&quot;,
           &quot;ResidenceMunicipality&quot;,&quot;ResidenceCountry&quot;,&quot;ResidenceMeridian&quot;,
           &quot;SourcePageNumber&quot;,&quot;ResidenceLandSection&quot;,
           &quot;SequenceNumber&quot;,&quot;HouseNumber&quot;)

xvars &lt;- setdiff(names(dta1921),xvars)
dta1921 &lt;- subset(dta1921, select = xvars )
saveRDS(dta1921,file=file.path(offpath,&quot;1921_Reduced.rds&quot;))
write_sav(dta1921, file.path(offpath,&quot;1921_Reduced.zsav&quot;), compress = T)</code></pre>
</div>
<div id="to-do-next" class="section level3">
<h3>To do Next</h3>
<ul>
<li>Manuel process the 29 lines that was exclude from the import</li>
<li></li>
</ul>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->



</body>
</html>
